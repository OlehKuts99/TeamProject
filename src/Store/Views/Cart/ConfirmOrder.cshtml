@model Store.ViewModels.ConfirmOrderView
@{
    ViewBag.Title = "Choose endpoint";
}

<link rel="stylesheet" href="~/css/mainPage.css" />

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCFlwlczCmamaKRfISTv2XvFJNttALOfnI&callback=initMap"
        async defer></script>


<script>
    var map;
    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 49.8397, lng: 24.0297 },
            zoom: 8
        });
    }

    function setMarker() {
        var select = document.getElementById('EndPointCity');
        var city = select.options[select.selectedIndex].value;

        var adress = city + ", " +
            document.getElementById('EndPointStreet').value;
        var resultlat = ''; var resultlng = '';
        $.ajax({
            async: false,
            dataType: "json",
            url: 'https://maps.google.com/maps/api/geocode/json?address=' + adress + '&key=AIzaSyCFlwlczCmamaKRfISTv2XvFJNttALOfnI',
            success: function (data) {
                for (var key in data.results) {
                    resultlat = data.results[key].geometry.location.lat;
                    resultlng = data.results[key].geometry.location.lng;
                }
            }
        });

        var marker = new google.maps.Marker({ position: { lat: resultlat, lng: resultlng }, map: map });
        map.panTo(new google.maps.LatLng(resultlat, resultlng));
        setDeliveryPrice();
    }

    function setDeliveryPrice() {
        var storages = document.getElementById('avaliableStorages');
        var additonalPrice = 120;

        if (storages.length == 0) {
            document.getElementById('deliveryPrice').textContent = additonalPrice;
            document.getElementById('commonPrice').textContent = '@Model.CommonPrice';
            var price = Number(document.getElementById('commonPrice').value);
            document.getElementById('commonPrice').value = (price + additonalPrice).toString();

            return;
        }

        var select = document.getElementById('EndPointCity');
        var city = select.options[select.selectedIndex].value;
        var isTheSamePlace = false;

        for (var i = 0; i < storages.length; i++) {
            if (storages[i].value == city) {
                document.getElementById('deliveryPrice').textContent = 15;
                document.getElementById('commonPrice').value = '@Model.CommonPrice';
                var price = Number(document.getElementById('commonPrice').value);
                document.getElementById('commonPrice').value = (price + 15).toString();
                isTheSamePlace = true;
            }
        }

        if (!isTheSamePlace) {
            document.getElementById('deliveryPrice').textContent = additonalPrice;
            document.getElementById('commonPrice').value = '@Model.CommonPrice';
            var price = Number(document.getElementById('commonPrice').value);
            document.getElementById('commonPrice').value = (price + additonalPrice).toString();
        }
    }
</script>

<div style="margin-top: 5%;">
    <form asp-action="ConfirmOrder">
        <div class="form-group">
            <label asp-for="EndPointCity">City</label>
            <select class="form-control" id="EndPointCity" name="EndPointCity">
                @foreach (var city in Model.Country.Cities)
                {
                    <option>@city</option>
                }
            </select>
        </div>
        <div class="form-group">
            <label asp-for="EndPointStreet">Street</label>
            <input id="EndPointStreet" asp-for="EndPointStreet" class="form-control" type="text" />
        </div>
        <div>
            <input type="button" value="Search" class="btn btn-warning center-button" onclick="setMarker()">
        </div>
        <div class="row" style="margin-bottom: 2%;">
            <h3 class="col-lg-3">Goods price : <span id="goodPrice">@Model.CommonPrice</span></h3>
            <h3 class="col-lg-3">Delivery price : <span id="deliveryPrice">-</span></h3>
            <h3 class="col-lg-4">Common price : <input style="width: 30%;" class="transparent-input" id="commonPrice" 
                                                       value="@Model.CommonPrice" name="commonPrice"></h3>
        </div>
        <div class="row">
            <div id="map" class="col-lg-12" ; style="height: 400px; box-shadow: 0 0 10px rgba(0,0,0,0.2);"></div>
        </div>
        <div class="form-group" style="display: none;">
            <select class="form-control" id="avaliableStorages">
                @foreach (var storage in Model.Storages)
                {
                    <option>@storage.City</option>
                }
            </select>
        </div>
        <div>
            <input type="submit" style="margin-top: 3%;" class="btn btn-success center-button" value="Confirm">
        </div>
    </form>
</div>

<h3 class="text-center">Products in order</h3>
<div class=" cart-goods">
    @foreach (var good in Model.Goods)
    {
        <div class="row cart-item">
            <div class="col-lg-3 col-3 text-center">
                <a asp-area="" asp-controller="GoodPage" asp-action="ShowGood" asp-route-goodId="@good.Good.Id">
                    <div><img src="../images/goods/@good.Good.PhotoUrl" /></div>
                </a>
            </div>
            <div class="col-lg-3 col-3">
                <p>Name : <a asp-area="" asp-controller="GoodPage" asp-action="ShowGood" asp-route-goodId="@good.Good.Id">@good.Good.Name</a></p>
                <p>Price : @good.Good.Price</p>
                <p>Count : @good.Count</p>
            </div>
        </div>
        <hr class="black-hr" />
    }
</div>